#!/bin/sh
set -eu

GHDL_EXE="${GHDL_EXE:-ghdl}"
if [ "$GHDL_EXE" = "ghdl" ]; then
  if [ -x "C:/code/ghdl-mcode-5.1.1-mingw64/bin/ghdl.exe" ]; then
    GHDL_EXE="C:/code/ghdl-mcode-5.1.1-mingw64/bin/ghdl.exe"
  elif [ -x "/c/code/ghdl-mcode-5.1.1-mingw64/bin/ghdl.exe" ]; then
    GHDL_EXE="/c/code/ghdl-mcode-5.1.1-mingw64/bin/ghdl.exe"
  fi
fi

echo "Running 68K30L GHDL tests before push..."

"$GHDL_EXE" -a --std=08 --ieee=synopsys \
  68K30L/wf68k30L_pkg.vhd \
  68K30L/wf68k30L_address_registers.vhd \
  68K30L/wf68k30L_alu.vhd \
  68K30L/wf68k30L_bus_interface.vhd \
  68K30L/wf68k30L_control.vhd \
  68K30L/wf68k30L_data_registers.vhd \
  68K30L/wf68k30L_exception_handler.vhd \
  68K30L/wf68k30L_opcode_decoder.vhd \
  68K30L/wf68k30L_top.vhd \
  68K30L/tb/tb_wf68k30L_alu.vhd \
  68K30L/tb/tb_wf68k30L_opcode_decoder.vhd \
  68K30L/tb/tb_wf68k30L_bus_interface.vhd \
  68K30L/tb/tb_wf68k30L_top_smoke.vhd

"$GHDL_EXE" -e --std=08 --ieee=synopsys tb_wf68k30L_alu
"$GHDL_EXE" -r --std=08 --ieee=synopsys tb_wf68k30L_alu --assert-level=error

"$GHDL_EXE" -e --std=08 --ieee=synopsys tb_wf68k30L_opcode_decoder
"$GHDL_EXE" -r --std=08 --ieee=synopsys tb_wf68k30L_opcode_decoder --assert-level=error

"$GHDL_EXE" -e --std=08 --ieee=synopsys tb_wf68k30L_bus_interface
"$GHDL_EXE" -r --std=08 --ieee=synopsys tb_wf68k30L_bus_interface --assert-level=error

"$GHDL_EXE" -e --std=08 --ieee=synopsys tb_wf68k30L_top_smoke
"$GHDL_EXE" -r --std=08 --ieee=synopsys tb_wf68k30L_top_smoke --assert-level=error

echo "68K30L GHDL tests passed."

